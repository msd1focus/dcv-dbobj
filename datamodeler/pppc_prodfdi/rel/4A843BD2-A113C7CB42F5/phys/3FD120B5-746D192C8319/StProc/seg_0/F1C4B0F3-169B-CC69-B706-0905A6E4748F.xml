<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureOraclev10g class="oracle.dbtools.crest.model.design.storage.oracle.v10g.StoredProcedureOraclev10g" name="GETDOUBLEPPV2" directorySegmentName="seg_0" id="F1C4B0F3-169B-CC69-B706-0905A6E4748F">
<sourceConnName>ProdFDI as focuspp</sourceConnName>
<sourceObjSchema>FOCUSPP</sourceObjSchema>
<sourceObjName>GETDOUBLEPPV2</sourceObjName>
<createdBy>FransMa</createdBy>
<createdTime>2019-10-28 02:55:06 UTC</createdTime>
<ownerDesignName>pppc_prodfdi</ownerDesignName>
<owner><![CDATA[4E5B45BD-E77E-0B6D-EFA2-DE9F30B5E31F]]></owner>
<source>CREATE OR REPLACE PROCEDURE         FOCUSPP.GETDOUBLEPPV2(
P_COMPANY IN VARCHAR2, 
P_STARTDATE IN VARCHAR2,
P_ENDDATE IN VARCHAR2, 
P_PRODUCTCATEGORY IN VARCHAR2, 
P_PRODUCTCLASS IN VARCHAR2, 
P_PRODUCTBRAND IN VARCHAR2, 
P_PRODUCTEXTENTION IN VARCHAR2, 
P_PRODUCTPACKAGING IN VARCHAR2, 
P_PRODUCTDETAIL IN VARCHAR2, 
P_PRODUCTVARIANT IN VARCHAR2,
P_REGION  IN VARCHAR2,
P_AREA IN VARCHAR2,
P_LOC IN VARCHAR2,
P_TYPE IN VARCHAR2,
P_GROUP IN VARCHAR2,
P_DETAIL IN VARCHAR2,
P_REFCUR   OUT SYS_REFCURSOR
)
IS
  VID NUMBER;
BEGIN
  SELECT REP_PP_DOUBLE_SEQ.NEXTVAL INTO VID FROM DUAL;
--OPEN P_REFCUR FOR
    Insert into ANALISA_PP_DOUBLE_TEMP (TRXID,ID, COMPANY_ID,START_DATE,END_DATE,PP,PP_STATUS,PC,PC_DATE,PEMOHON,PROG_PROMO,PROPOSAL_TYPE,MEKANISME_PENAGIHAN,CUST_REGION,CUST_AREA,CUST_LOC,CUST_TYPE,CUST_GROUP,CUST_DETAIL,EXCLUDED_CUST,LINE_NO,PRODUCT_CATEGORY,PRODUCT_CATEGORY_CODE,PRODUCT_CLASS,PRODUCT_CLASS_CODE,PRODUCT_BRAND,PRODUCT_BRAND_CODE,PRODUCT_EXTENSION,PRODUCT_EXTENSION_CODE,PRODUCT_PACKAGING,PRODUCT_PACKAGING_CODE,PRODUCT_VARIANT,PRODUCT_VARIANT_CODE,PRODUCT_DETAIL,PRODUCT_DETAIL_CODE,MEKANISME,DESCRIPTION,DETIL_PROMO,ON_TOP_TPB,MF_PB,TOTAL_ON_TOP_TPB,TOTAL_MF_PB)
    SELECT VID,ROWNUM, COMPANY_ID,
       START_DATE,
       END_DATE,
       PP,
       PP_STATUS,
       PC,
       PC_DATE,
       PEMOHON,
       PROG_PROMO,
       PROPOSAL_TYPE,
       MEKANISME_PENAGIHAN,
       CUST_REGION,
       CUST_AREA,
       CUST_LOC,
       CUST_TYPE,
       CUST_GROUP,
       CUST_DETAIL,
       EXCLUDED_CUST,
       LINE_NO,
       PRODUCT_CATEGORY,
        PRODUCT_CATEGORY_CODE,
        PRODUCT_CLASS,
        PRODUCT_CLASS_CODE,
        PRODUCT_BRAND,
        PRODUCT_BRAND_CODE,
        PRODUCT_EXTENSION,
        PRODUCT_EXTENSION_CODE,
        PRODUCT_PACKAGING,
        PRODUCT_PACKAGING_CODE,
        PRODUCT_VARIANT,
        PRODUCT_VARIANT_CODE,
        PRODUCT_DETAIL,
        PRODUCT_DETAIL_CODE,
       MEKANISME,
       DESCRIPTION,
       DETIL_PROMO,
       ON_TOP_TPB,
       MF_PB,
       TOTAL_ON_TOP_TPB,
       TOTAL_MF_PB
  FROM FCS_VIEW_REPORT_PCPP
 WHERE COMPANY_ID =NVL(P_COMPANY,COMPANY_ID)
AND PRODUCT_CATEGORY_CODE = NVL(P_PRODUCTCATEGORY,PRODUCT_CATEGORY_CODE)
AND PRODUCT_CLASS_CODE = NVL(P_PRODUCTCLASS,PRODUCT_CLASS_CODE)
AND PRODUCT_BRAND_CODE = NVL(P_PRODUCTBRAND,PRODUCT_BRAND_CODE)
AND PRODUCT_EXTENSION_CODE = NVL(P_PRODUCTEXTENTION,PRODUCT_EXTENSION_CODE)
AND PRODUCT_PACKAGING_CODE = NVL(P_PRODUCTPACKAGING,PRODUCT_PACKAGING_CODE)
AND NVL(PRODUCT_DETAIL_CODE,&apos;kosong&apos;) LIKE NVL(P_PRODUCTDETAIL,&apos;%&apos;)
AND NVL(PRODUCT_VARIANT_CODE,&apos;kosong&apos;) LIKE NVL(P_PRODUCTVARIANT,&apos;%&apos;)
AND REGEXP_LIKE (NVL(CUST_REGION,&apos;kosong&apos;),
(
SELECT DECODE(CUST_REGION, &apos;&apos;, &apos;kosong&apos;, LISTAGG(REGION, &apos;|&apos;) WITHIN GROUP (ORDER BY REGION))
    FROM (
            SELECT DISTINCT AC.ATTRIBUTE3 AS REGION
            FROM APPS.AR_CUSTOMERS AC
            WHERE AC.ATTRIBUTE3 = NVL(P_REGION,AC.ATTRIBUTE3)
            AND AC.ATTRIBUTE4 = NVL(P_AREA,AC.ATTRIBUTE4)
            AND AC.ATTRIBUTE5 = NVL(P_LOC, AC.ATTRIBUTE5)
            AND AC.ATTRIBUTE8 = NVL(P_TYPE, AC.ATTRIBUTE8)
            AND AC.ATTRIBUTE1 = NVL(P_GROUP, AC.ATTRIBUTE1)
            AND AC.CUSTOMER_NUMBER = NVL(P_DETAIL, AC.CUSTOMER_NUMBER)
         )
))
AND REGEXP_LIKE (NVL(CUST_AREA,&apos;kosong&apos;),
(
    SELECT DECODE(CUST_AREA, &apos;&apos;, &apos;kosong&apos;, LISTAGG(AREA, &apos;|&apos;) WITHIN GROUP (ORDER BY AREA))
    FROM (
            SELECT DISTINCT AC.ATTRIBUTE4 AS AREA
            FROM APPS.AR_CUSTOMERS AC
            WHERE AC.ATTRIBUTE3 = NVL(P_REGION,AC.ATTRIBUTE3)
            AND AC.ATTRIBUTE4 = NVL(P_AREA,AC.ATTRIBUTE4)
            AND AC.ATTRIBUTE5 = NVL(P_LOC, AC.ATTRIBUTE5)
            AND AC.ATTRIBUTE8 = NVL(P_TYPE, AC.ATTRIBUTE8)
            AND AC.ATTRIBUTE1 = NVL(P_GROUP, AC.ATTRIBUTE1)
            AND AC.CUSTOMER_NUMBER = NVL(P_DETAIL, AC.CUSTOMER_NUMBER)
         )
))
AND REGEXP_LIKE (NVL(CUST_LOC,&apos;kosong&apos;),
(
    SELECT DECODE(CUST_LOC, &apos;&apos;, &apos;kosong&apos;, LISTAGG(LOC, &apos;|&apos;) WITHIN GROUP (ORDER BY LOC))
    FROM (
            SELECT DISTINCT AC.ATTRIBUTE5 AS LOC
            FROM APPS.AR_CUSTOMERS AC
           WHERE AC.ATTRIBUTE3 = NVL(P_REGION,AC.ATTRIBUTE3)
            AND AC.ATTRIBUTE4 = NVL(P_AREA,AC.ATTRIBUTE4)
            AND AC.ATTRIBUTE5 = NVL(P_LOC, AC.ATTRIBUTE5)
            AND AC.ATTRIBUTE8 = NVL(P_TYPE, AC.ATTRIBUTE8)
            AND AC.ATTRIBUTE1 = NVL(P_GROUP, AC.ATTRIBUTE1)
            AND AC.CUSTOMER_NUMBER = NVL(P_DETAIL, AC.CUSTOMER_NUMBER)
         )
))
AND REGEXP_LIKE (NVL(CUST_TYPE,&apos;kosong&apos;),
(
    SELECT DECODE(CUST_TYPE, &apos;&apos;, &apos;kosong&apos;, LISTAGG(C_TYPE, &apos;|&apos;) WITHIN GROUP (ORDER BY C_TYPE))
    FROM (
            SELECT DISTINCT AC.ATTRIBUTE8 AS C_TYPE
            FROM APPS.AR_CUSTOMERS AC
              WHERE AC.ATTRIBUTE3 = NVL(P_REGION,AC.ATTRIBUTE3)
            AND AC.ATTRIBUTE4 = NVL(P_AREA,AC.ATTRIBUTE4)
            AND AC.ATTRIBUTE5 = NVL(P_LOC, AC.ATTRIBUTE5)
            AND AC.ATTRIBUTE8 = NVL(P_TYPE, AC.ATTRIBUTE8)
            AND AC.ATTRIBUTE1 = NVL(P_GROUP, AC.ATTRIBUTE1)
            AND AC.CUSTOMER_NUMBER = NVL(P_DETAIL, AC.CUSTOMER_NUMBER)
         )
))
AND REGEXP_LIKE (NVL(CUST_GROUP,&apos;kosong&apos;),
(
    SELECT DECODE(CUST_GROUP, &apos;&apos;, &apos;kosong&apos;, LISTAGG(C_GROUP, &apos;|&apos;) WITHIN GROUP (ORDER BY C_GROUP))
    FROM (
            SELECT DISTINCT AC.ATTRIBUTE1 AS C_GROUP
            FROM APPS.AR_CUSTOMERS AC
            WHERE AC.ATTRIBUTE3 = NVL(P_REGION,AC.ATTRIBUTE3)
            AND AC.ATTRIBUTE4 = NVL(P_AREA,AC.ATTRIBUTE4)
            AND AC.ATTRIBUTE5 = NVL(P_LOC, AC.ATTRIBUTE5)
            AND AC.ATTRIBUTE8 = NVL(P_TYPE, AC.ATTRIBUTE8)
            AND AC.ATTRIBUTE1 = NVL(P_GROUP, AC.ATTRIBUTE1)
            AND AC.CUSTOMER_NUMBER = NVL(P_DETAIL, AC.CUSTOMER_NUMBER)
         )
))
AND REGEXP_LIKE (NVL(CUST_DETAIL,&apos;kosong&apos;),
(
    SELECT DECODE(CUST_DETAIL, &apos;&apos;, &apos;kosong&apos;, LISTAGG(CUSTOMER, &apos;|&apos;) WITHIN GROUP (ORDER BY CUSTOMER))
    FROM (
            SELECT DISTINCT AC.CUSTOMER_NUMBER AS CUSTOMER
            FROM APPS.AR_CUSTOMERS AC
            WHERE AC.ATTRIBUTE3 = NVL(P_REGION,AC.ATTRIBUTE3)
            AND AC.ATTRIBUTE4 = NVL(P_AREA,AC.ATTRIBUTE4)
            AND AC.ATTRIBUTE5 = NVL(P_LOC, AC.ATTRIBUTE5)
            AND AC.ATTRIBUTE8 = NVL(P_TYPE, AC.ATTRIBUTE8)
            AND AC.ATTRIBUTE1 = NVL(P_GROUP, AC.ATTRIBUTE1)
            AND AC.CUSTOMER_NUMBER = NVL(P_DETAIL, AC.CUSTOMER_NUMBER)
         )
));
OPEN P_REFCUR FOR
WITH BASICDATA AS (
SELECT C.ID,
       C.COMPANY_ID,
       C.START_DATE,
       C.END_DATE,
      C.PP,
       C.PP_STATUS,
       C.PC,
       C.PC_DATE,
       C.PEMOHON,
       C.PROG_PROMO,
       C.PROPOSAL_TYPE,
       C.MEKANISME_PENAGIHAN,
       C.CUST_REGION,
       C.CUST_AREA,
       C.CUST_LOC,
       C.CUST_TYPE,
       C.CUST_GROUP,
       C.CUST_DETAIL,
       C.EXCLUDED_CUST,
       C.LINE_NO,
       C.PRODUCT_CATEGORY,
        C.PRODUCT_CATEGORY_CODE,
        C.PRODUCT_CLASS,
        C.PRODUCT_CLASS_CODE,
        C.PRODUCT_BRAND,
        C.PRODUCT_BRAND_CODE,
        C.PRODUCT_EXTENSION,
        C.PRODUCT_EXTENSION_CODE,
        C.PRODUCT_PACKAGING,
        C.PRODUCT_PACKAGING_CODE,
        C.PRODUCT_VARIANT,
        C.PRODUCT_VARIANT_CODE,
        C.PRODUCT_DETAIL,
        C.PRODUCT_DETAIL_CODE,
       C.MEKANISME,
       C.DESCRIPTION,
       C.DETIL_PROMO,
       C.ON_TOP_TPB,
       C.MF_PB,
       C.TOTAL_ON_TOP_TPB,
       C.TOTAL_MF_PB FROM ANALISA_PP_DOUBLE_TEMP C
WHERE TRXID=VID AND C.END_DATE &gt;= TO_DATE(P_STARTDATE,&apos;DD/MM/YYYY&apos;)  --STARTPARAM
  AND C.START_DATE &lt;= TO_DATE(P_ENDDATE,&apos;DD/MM/YYYY&apos;))
 select * from(select distinct a.*
from BASICDATA a
join BASICDATA b on (a.END_DATE &gt;= b.START_DATE)
                and (b.END_DATE &gt;= a.START_DATE)
                and (a.ID &lt;&gt; b.ID))
                order by START_DATE, PP;
END GETDOUBLEPPv2;</source>
</StoredProcedureOraclev10g>